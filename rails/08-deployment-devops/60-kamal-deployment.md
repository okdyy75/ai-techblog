# Kamal (旧MRSK) を使ったRailsアプリケーションのデプロイ戦略

Railsアプリケーションのデプロイには、HerokuやRenderのようなPaaS、Capistranoのようなデプロイスクリプト、あるいはCI/CDパイプラインからの手動デプロイなど、様々な選択肢があります。

近年、コンテナ技術（Docker）の普及に伴い、新しいデプロイの選択肢として注目を集めているのが、Railsの作者であるDHH氏が開発した**Kamal**（旧名: MRSK）です。

Kamalは、Dockerコンテナ化したRailsアプリケーションを、任意のサーバー（クラウド、VPS、ベアメタルなど）に、非常にシンプルなコマンドでデプロイするためのツールです。

この記事では、Kamalがどのような問題を解決し、どのように機能するのか、そしてCapistranoやPaaSとは何が違うのかについて解説します。

## Kamalとは？

Kamalのコンセプトは「**コンテナのパワーを、PaaSのような手軽さで**」です。

HerokuのようなPaaSは非常に手軽ですが、プラットフォームにロックインされ、インフラの柔軟性やコスト面に制約があります。一方、Capistranoは柔軟ですが、サーバーごとにRubyや依存ライブラリのバージョンを管理する必要があり、環境の差異に悩まされることがあります。

Kamalは、これらの問題点を解決します。

- **Dockerによる環境のポータビリティ**: アプリケーションはDockerイメージとしてビルドされるため、「開発環境では動いたのに本番環境では動かない」といった問題が起こりません。
- **サーバーを選ばない**: SSHでアクセスできるサーバーであれば、どこにでもデプロイできます。特定のクラウドプロバイダーに依存しません。
- **シンプルな設定**: `config/deploy.yml`という単一のYAMLファイルで、デプロイのすべてを定義します。
- **ゼロダウンタイムデプロイ**: 新しいバージョンのコンテナを起動し、ヘルスチェックが通ってからリクエストを切り替えるため、デプロイ中にサービスが停止することはありません。

## Kamalの仕組み

Kamalのデプロイプロセスは、いくつかのシンプルなステップで構成されています。

1.  **Dockerイメージのビルド**: ローカルマシンまたはCIサーバー上で、`Dockerfile`を元にアプリケーションのDockerイメージをビルドします。
2.  **イメージのプッシュ**: ビルドしたDockerイメージを、Docker HubやGitHub Container Registryなどのコンテナレジストリにプッシュします。
3.  **サーバーへの接続**: `config/deploy.yml`に定義されたデプロイ先サーバーにSSHで接続します。
4.  **コンテナのプル**: 各サーバーが、レジストリから新しいバージョンのDockerイメージをプルします。
5.  **コンテナの起動**: 新しいバージョンのコンテナを起動します。
6.  **ヘルスチェック**: 新しいコンテナが正常にリクエストを処理できる状態かを確認します。
7.  **リクエストの切り替え**: ヘルスチェックが成功したら、リバースプロキシ（デフォルトではTraefik）が、新しいコンテナにリクエストを振り向けるように設定を変更します。
8.  **古いコンテナの停止**: 古いバージョンのコンテナを停止・削除します。

この一連の流れが、`kamal deploy`という一つのコマンドで実行されます。

## セットアップと使い方

### 1. インストール

`kamal` gemをインストールします。

```bash
gem install kamal
```

### 2. 初期化

Railsアプリケーションのルートで`kamal init`を実行します。

```bash
kamal init
```

これにより、以下のファイルが生成されます。

- `config/deploy.yml`: デプロイ設定ファイル。
- `.env`: 本番環境の環境変数やレジストリのパスワードなどを格納するファイル（`.gitignore`に追加されます）。
- `Dockerfile`: Railsアプリケーションをコンテナ化するためのファイル。
- `.docker/entrypoint.sh`: コンテナ起動時に実行されるスクリプト。

### 3. `config/deploy.yml`の設定

デプロイ設定ファイルに、アプリケーション名、デプロイ先サーバーの情報、レジストリ情報などを記述します。

```yaml
# config/deploy.yml
service: my-rails-app

image: my-registry/my-rails-app

servers:
  web:
    hosts:
      - 192.168.1.10
      - 192.168.1.11
    labels:
      traefik.http.routers.my-app.rule: "Host(`www.example.com`)"

registry:
  server: my-registry
  username: my-username
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  clear:
    RAILS_MASTER_KEY: # .envから読み込む
```

- `service`: アプリケーション名。
- `image`: プッシュ先のコンテナイメージ名。
- `servers`: デプロイ先サーバーのIPアドレスやホスト名を列挙します。
- `registry`: Dockerレジストリの認証情報。
- `env`: コンテナに渡す環境変数。

### 4. デプロイ

準備ができたら、`deploy`コマンドを実行します。

```bash
kamal deploy
```

これだけで、ビルドからデプロイまでの全プロセスが自動的に実行されます。

## Kamalのその他の機能

- **データベースやRedisの管理**: `kamal mysql`, `kamal redis`といったコマンドで、補助的なサービスもコンテナとして簡単にデプロイ・管理できます。
- **環境変数の管理**: `kamal env push`で`.env`ファイルの内容を安全にサーバーに転送できます。
- **ログの閲覧**: `kamal app logs`で、全サーバーのアプリケーションログをストリーミング表示できます。
- **コンソール/DBコンソールへのアクセス**: `kamal app console`, `kamal db console`で、稼働中のコンテナに対してRailsコンソールやDBコンソールを開くことができます。

## まとめ

Kamalは、現代的なコンテナベースのデプロイを、Railsらしいシンプルさと手軽さで実現するツールです。

- **PaaSの手軽さ**と**IaaSの柔軟性**を両立。
- Dockerによる**環境の完全なポータビリティ**を実現。
- `config/deploy.yml`という**単一ファイルでのシンプルな設定**。
- **ゼロダウンタイムデプロイ**を標準でサポート。

小規模な個人プロジェクトから、複数のサーバーで構成される本格的なプロダクション環境まで、幅広いスケールに対応できます。

もしあなたが、PaaSの制約や、Capistranoでのサーバー環境管理に課題を感じているなら、Kamalは非常に魅力的な選択肢となるでしょう。Dockerの学習コストは必要ですが、それを乗り越えれば、クリーンで再現性の高い、モダンなデプロイフローを手に入れることができます。
